<!DOCTYPE HTML>
<html>
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/main.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="icon" href="https://spike.ist/assets/spike-favicon-16x16.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <title> SPIKE | Nil Source Handling and Go Concurrency Guarantees </title>
</head>
<body>

<main>
    
    <nav>
  <script>
    fetch('https://api.github.com/repos/spiffe/spike/releases/latest')
        .then(response => response.json())
        .then(data => {
            const release = document.getElementById('release');
            const icon = '<i class="bx bx-package"></i>';
            release.href = data.name ? data.html_url : 'https://api.github.com/repos/spiffe/spike/releases';
            release.innerHTML = icon + (data.name ? ' ' + data.name : ' Releases');
        });
</script>
<div id="banner">
    <a href="https://spike.ist">
        <img id="banner-image" src="https://spike.ist/assets/spike-banner.png" alt="logo" />
    </a>
    <div id="banner-body">
        <a class="banner-title" href="https://spike.ist">
            SPIKE
        </a>
        <span class="banner-tagline">
            Secure your secrets<br> with SPIFFE.
        </span>
        <a id="release" class="banner-link" href="https://github.com/spiffe/spike/releases">
            <i class='bx bx-package'></i>
        </a>
        <a href="https://github.com/spiffe/spike" class="banner-link">
            <i class='bx bxl-github'></i> GitHub
        </a>

    </div>
</div>
<style>
   /* Banner on top of the nav */
   #banner {
        position: sticky;
        background-color: var(--bg-primary);
        z-index: 100;
        top: 0;
        display: flex;
        flex-direction: row;
        padding: 1rem;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        margin-bottom: 1rem;
    }

    #banner img {
        width: 100px;
        height: auto;
    }

    #banner-body {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        justify-content: space-between;
        margin-left: 1rem;
    }

    .banner-title {
        font-size: 1.75rem;
        font-weight: 700;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        margin-bottom: -15px;
        font-family: var(--brand-font-family);
    }
    .banner-tagline {
        font-size: 0.875rem;
        color: var(--text-muted);
        font-style: italic;
    }

    .banner-link {
        display: flex;
        gap: 0.5rem;
        min-width: 84px;
        font-size: 0.875rem;
        font-weight: 300;
        padding: 0.25rem 0.75rem;
        border-radius: 4px;
        background-color: var(--bg-interactive);
        transition: all 0.2s ease;
    }

    .banner-link i {
        font-size: 1.125rem;
        color: var(--spike-blue);
    }

    .banner-link:hover {
        background-color: var(--spike-blue);
    }
</style> <div id="trees">
    <input class="tree-toggle" type="checkbox" id="about"
               />
        <label class="tree-toggle-label "
               for="about">About</label>

        <ul class="subtree">
            <li >
                    <a href="https://spike.ist/about/intro/">About SPIKE</a>
                </li>

                <li >
                    <a href="https://spike.ist/about/project-status/">Project Maturity</a>
                </li>

                </ul>
    <input class="tree-toggle" type="checkbox" id="community"
               />
        <label class="tree-toggle-label "
               for="community">Community</label>

        <ul class="subtree">
            <li >
                    <a href="https://spike.ist/community/hello/">Hello Universe</a>
                </li>

                <li >
                    <a href="https://spike.ist/community/contact/">Contact Us</a>
                </li>

                <li >
                    <a href="https://spike.ist/community/presentations/">Presentations and Demos</a>
                </li>

                <li >
                    <a href="https://spike.ist/community/resources/">Resources</a>
                </li>

                </ul>
    <input class="tree-toggle" type="checkbox" id="getting-started"
               />
        <label class="tree-toggle-label "
               for="getting-started">Getting Started</label>

        <ul class="subtree">
            <li >
                    <a href="https://spike.ist/getting-started/quickstart/">SPIKE Quickstart Guide</a>
                </li>

                </ul>
    <input class="tree-toggle" type="checkbox" id="using-spike"
               />
        <label class="tree-toggle-label "
               for="using-spike">Using SPIKE</label>

        <ul class="subtree">
            <li >
                    <a href="https://spike.ist/usage/configuration/">Configuring SPIKE</a>
                </li>

                <li >
                    <a href="https://spike.ist/usage/cli/">SPIKE CLI</a>
                </li>

                </ul>
    <input class="tree-toggle" type="checkbox" id="developing-spike"
               />
        <label class="tree-toggle-label "
               for="developing-spike">Developing SPIKE</label>

        <ul class="subtree">
            <li >
                    <a href="https://spike.ist/development/local-deployment/">SPIKE on Kubernetes</a>
                </li>

                <li >
                    <a href="https://spike.ist/development/bare-metal/">SPIKE on Linux</a>
                </li>

                <li >
                    <a href="https://spike.ist/development/api-docs/">API Documentation</a>
                </li>

                </ul>
    <input class="tree-toggle" type="checkbox" id="spike-architecture"
               />
        <label class="tree-toggle-label "
               for="spike-architecture">SPIKE Architecture</label>

        <ul class="subtree">
            <li >
                    <a href="https://spike.ist/architecture/system-overview/">System Overview</a>
                </li>

                <li >
                    <a href="https://spike.ist/architecture/security-model/">SPIKE Security Model</a>
                </li>

                <li >
                    <a href="https://spike.ist/architecture/architectural-decision-records/">ADRs</a>
                </li>

                </ul>
    <input class="tree-toggle" type="checkbox" id="tracking"
               />
        <label class="tree-toggle-label "
               for="tracking">Tracking</label>

        <ul class="subtree">
            <li >
                    <a href="https://spike.ist/tracking/changelog/">Changelog</a>
                </li>

                <li >
                    <a href="https://spike.ist/tracking/snapshots/">Documentation Snapshots</a>
                </li>

                </ul>
    <input class="tree-toggle" type="checkbox" id="operations"
               />
        <label class="tree-toggle-label "
               for="operations">Operations</label>

        <ul class="subtree">
            <li >
                    <a href="https://spike.ist/operations/build/">SPIKE Cross-Platform Build</a>
                </li>

                <li >
                    <a href="https://spike.ist/operations/production/">SPIKE Production Setup</a>
                </li>

                <li >
                    <a href="https://spike.ist/operations/recovery/">SPIKE Recovery Procedures</a>
                </li>

                <li >
                    <a href="https://spike.ist/operations/backup/">SPIKE Backup and Restore</a>
                </li>

                <li >
                    <a href="https://spike.ist/operations/release/">SPIKE Relase Management</a>
                </li>

                </ul>
    </div>
<style>
    /* Navigation tree structure */
    #trees {
        padding: 0 1rem;
    }

    .tree-toggle {
        display: none;
    }

    .tree-toggle:checked + .tree-toggle-label + .subtree {
        display: block;
    }

    .tree-toggle-label {
        display: block;
        padding: 0.75rem 1rem;
        margin: 0.25rem 0;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .tree-toggle-label:hover {
        background-color: rgba(0, 0, 0, 0.05);
    }

    .tree-toggle-label::before {
        content: '▸';
        display: inline-block;
        margin-right: 0.5rem;
        transition: transform 0.2s ease;
    }

    .tree-toggle:checked + .tree-toggle-label::before {
        transform: rotate(90deg);
    }

    .subtree {
        display: none;
        margin: 0;
        padding: 0 0 0 1rem;
        list-style: none;
    }

    .subtree li {
        margin: 0.25rem 0;
    }

    .subtree li a {
        display: block;
        padding: 0.5rem 1rem;
        text-decoration: none;
        border-radius: 4px;
        font-size: 0.9375rem;
        transition: all 0.2s ease;
    }

    .subtree li a:hover {
        background-color: rgba(0, 0, 0, 0.05);
    }

    .subtree li.active a {
        font-weight: 600;
        background-color: rgba(0, 0, 0, 0.05);
    }

    /* Table of contents styling */
    #toc {
        margin: 0.5rem 0 0.5rem 1.5rem;
        padding: 0;
        list-style: none;
        font-size: 0.875rem;
    }

    #toc li {
        margin: 0.25rem 0;
    }

    #toc li a {
        padding: 0.375rem 0.75rem;
        opacity: 0.8;
    }

    #toc li a:hover {
        opacity: 1;
    }

    #toc ul {
        margin: 0.25rem 0 0.25rem 1rem;
        padding: 0;
        list-style: none;
    }
</style>
</nav>
<style>
  nav {
    position: sticky;
    width: 300px;
    height: 100vh;
    top: 0;
    max-height: 100vh;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: rgba(0, 0, 0, 0.3) transparent;
    z-index: 100;
    box-shadow: 5px 0 20px var(--shadow-color);
    border-right: 1px solid var(--border-color);
    transition: transform 0.4s ease-in-out;
    background-color: var(--bg-primary);
  }

  nav::-webkit-scrollbar {
    width: 8px;
  }

  nav::-webkit-scrollbar-track {
    background: transparent;
  }

  nav::-webkit-scrollbar-thumb {
    background-color: rgba(0, 0, 0, 0.3);
    border-radius: 4px;
    border: 2px solid transparent;
  }

  @media (max-width: 1300px) {
    .nav-toggle {
      display: none;
    }

    nav {
      position: fixed;
      transform: translateX(-100%);
      width: 85%;
      max-width: 300px;
      height: calc(100vh - 57px);
      top: 57px;
    }

    nav.active {
      transform: translateX(0);
    }
  }
</style>


    <div class="content">
        <div class="header">
  <div class="header-content">
    <button
      id="mobile-nav-toggle"
      aria-label="Toggle navigation"
      class="mobile-only"
    >
      <i class="bx bx-menu"></i>
    </button>
    <script>
  document.addEventListener("DOMContentLoaded", () => {
    const searchInput = document.querySelector(".search-input");
    const overlay = document.querySelector(".overlay");
    const searchResults = document.querySelector(".search-results");

    function closeSearch() {
      overlay.style.display = "none";
      searchResults.style.display = "none";
      searchInput.blur();
    }

    function openSearch() {
      overlay.style.display = "block";
      searchResults.style.display = "block";
    }

    searchInput.addEventListener("focus", openSearch);
    overlay.addEventListener("click", closeSearch);
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        closeSearch();
      }
    });
  });
</script>
<div class="overlay"></div>
<input class="search-input" type="text" placeholder="Search..." />
<div class="search-results">
  <div class="search-results__header">
    <span class="search-results__count">Waiting for input...</span>
  </div>
  <div class="search-results__items"></div>
</div>

<style>
  .search-input {
    width: 100%;
    padding: 0.5rem 1rem;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background-color: var(--bg-interactive);
    color: var(--text-primary);
    font-size: 0.875rem;
    transition: all 0.2s ease;
    z-index: 101;
  }

  .search-input:focus {
    outline: none;
    border-color: var(--spike-blue);
    background-color: var(--bg-primary);
    box-shadow: 0 0 0 2px rgba(var(--spike-blue-rgb), 0.2);
  }

  .search-input::placeholder {
    color: var(--text-muted);
  }

  .overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 100;
  }

  .search-results {
    display: none;
    position: absolute;
    left: 0;
    right: 0;
    top: 100%;
    max-width: 700px;
    margin: 0.5rem auto;
    background: var(--bg-primary);
    border-radius: 8px;
    box-shadow: 0px 4px 8px 3px rgba(0, 0, 0, 0.1);
    border: 1px solid var(--border-color);
    z-index: 102;
  }

  .search-results__header {
    padding: 0.75rem 1rem;
    color: var(--text-muted);
    font-size: 0.875rem;
    border-bottom: 1px solid var(--border-color);
  }

  .search-results__items {
    max-height: 60vh;
    overflow-y: auto;
  }

  .search-results__item {
    display: block;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border-color);
    transition: background-color 0.2s ease;
  }

  .search-results__item:hover {
    background-color: var(--bg-interactive);
  }

  .search-results__title {
    color: var(--spike-blue);
    font-size: 0.875rem;
    font-weight: 500;
    margin-bottom: 0.25rem;
  }

  .search-results__preview {
    color: var(--text-secondary);
    font-size: 0.8125rem;
    line-height: 1.4;
  }

  .search-results__preview b {
    color: var(--spike-dark-green);
    font-weight: 600;
  }

  .search-results__items::-webkit-scrollbar {
    width: 4px;
  }

  .search-results__items::-webkit-scrollbar-thumb {
    background: var(--border-color);
    border-radius: 4px;
  }

  /* Empty state */
  .search-results__empty {
    padding: 2rem 1rem;
    text-align: center;
    color: var(--text-muted);
    font-size: 0.875rem;
  }
</style>

    <a
      href="https://github.com/spiffe/spike"
      target="_blank"
      rel="noopener"
      class="github-star"
    >
      <i class="bx bx-star"></i>
      <span>Star <strong>SPIKE</strong> on <strong>GitHub</strong></span>
    </a>
    <button id="theme-toggle" aria-label="Toggle theme">
      <i class="bx bx-sun light-icon"></i>
      <i class="bx bx-moon dark-icon"></i>
    </button>
  </div>
</div>

<style>
  .header {
    position: sticky;
    top: 0;
    background-color: var(--bg-primary);
    padding: 1rem;
    border-bottom: 1px solid var(--border-color);
    box-shadow: 0 4px 6px -1px var(--shadow-color),
      0 2px 4px -1px var(--shadow-color);
    z-index: 101;
  }

  .header-content {
    max-width: 800px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  #mobile-nav-toggle {
    display: none;
    background: none;
    border: none;
    padding: 0.5rem;
    cursor: pointer;
    color: var(--text-primary);
    font-size: 1.5rem;
    border-radius: 4px;
    transition: all 0.2s ease;
  }

  #mobile-nav-toggle i {
    pointer-events: none;
    display: block;
  }

  #mobile-nav-toggle:hover {
    background-color: var(--bg-interactive);
  }

  @media (max-width: 1300px) {
    #mobile-nav-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
    }
  }

  #theme-toggle {
    background: none;
    border: none;
    padding: 0.5rem;
    cursor: pointer;
    color: var(--text-primary);
    font-size: 1.25rem;
    border-radius: 4px;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  #theme-toggle:hover {
    background-color: var(--bg-interactive);
  }

  #theme-toggle:active {
    background-color: var(--bg-secondary);
  }

  /* Show/hide icons based on theme */
  [data-theme="dark"] .light-icon,
  :root:not([data-theme="dark"]) .dark-icon {
    display: none;
  }

  /* GitHub Star Button */
  .github-star {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    color: white;
    text-decoration: none;
    background: linear-gradient(
      135deg,
      var(--spike-blue),
      var(--spike-dark-green)
    );
    border-radius: 20px;
    transition: all 0.2s ease;
    font-size: 0.875rem;
    white-space: nowrap;
  }

  .github-star:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(var(--spike-blue-rgb), 0.3);
  }

  .github-star i {
    font-size: 1.1rem;
    animation: starBounce 2s infinite;
    color: #ffd700;
    text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
  }

  @keyframes starBounce {
    0%,
    100% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.2);
    }
  }

  .github-star span {
    white-space: nowrap;
  }

  @media (max-width: 768px) {
    .github-star span {
      display: none;
    }

    .github-star {
      padding: 0.5rem;
    }
  }
</style>

<script>
  // Theme toggle functionality
  document.addEventListener("DOMContentLoaded", () => {
    const themeToggle = document.getElementById("theme-toggle");

    // Function to set theme
    function setTheme(theme) {
      document.documentElement.setAttribute("data-theme", theme);
      localStorage.setItem("theme", theme);
      
      // Update banner image based on theme
      const bannerImage = document.getElementById("banner-image");
      if (bannerImage) {
        bannerImage.src = theme === "dark" 
          ? "/assets/spike-banner-dark-thin.png"
          : "/assets/spike-banner-light-thin.png";
      }
    }

    // Initialize theme
    const savedTheme = localStorage.getItem("theme");
    setTheme(savedTheme ? savedTheme : "dark");
    // Discard system theme changes; the landing page is always dark, so
    // it's better to transition to a dark-by-default theme.
    // } else if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
    //   setTheme("dark");
    // }

    // Toggle theme on button click
    themeToggle.addEventListener("click", () => {
      const currentTheme = document.documentElement.getAttribute("data-theme");
      const newTheme = currentTheme === "dark" ? "light" : "dark";
      setTheme(newTheme);
    });

    // Discard system-theme changes.
    // window
    //   .matchMedia("(prefers-color-scheme: dark)")
    //   .addEventListener("change", (e) => {
    //     if (!localStorage.getItem("theme")) {
    //       setTheme(e.matches ? "dark" : "light");
    //     }
    //   });
  });
</script>


        <article>
            
        <h1 id="nil-source-handling-and-go-concurrency-guarantees">Nil Source Handling and Go Concurrency Guarantees</h1>
<p>This document explains the defensive nil checks for <code>*workloadapi.X509Source</code>
throughout the SPIKE codebase and the concurrency guarantees that make them
safe.</p>
<h2 id="table-of-contents">Table of Contents</h2>
<ol>
<li><a href="https://spike.ist/internals/nil-source-handling-and-go-concurrency/#why-check-for-nil-source">Why Check for Nil Source?</a></li>
<li><a href="https://spike.ist/internals/nil-source-handling-and-go-concurrency/#when-to-crash-vs-retry">When to Crash vs. Retry</a></li>
<li><a href="https://spike.ist/internals/nil-source-handling-and-go-concurrency/#call-chain-analysis">Call Chain Analysis</a></li>
<li><a href="https://spike.ist/internals/nil-source-handling-and-go-concurrency/#pointer-stability-in-closures">Pointer Stability in Closures</a></li>
<li><a href="https://spike.ist/internals/nil-source-handling-and-go-concurrency/#go-error-handling-contract">Go Error Handling Contract</a></li>
<li><a href="https://spike.ist/internals/nil-source-handling-and-go-concurrency/#concurrency-and-memory-model">Concurrency and Memory Model</a></li>
</ol>
<h2 id="why-check-for-nil-source">Why Check for Nil Source?</h2>
<p>In concurrent/distributed systems, the SPIFFE Workload API can asynchronously
invalidate the X509Source. While rare, this can happen due to:</p>
<ul>
<li>Workload API connection loss</li>
<li>UDS socket issues</li>
<li>SPIRE Agent problems</li>
<li>Transient network failures</li>
</ul>
<h3 id="pattern-throughout-codebase">Pattern Throughout Codebase</h3>
<p>We implement defensive nil checks at strategic points to handle this gracefully.</p>
<h2 id="when-to-crash-vs-retry">When to Crash vs. Retry</h2>
<h3 id="crash-immediately-server-startup">Crash Immediately (Server Startup)</h3>
<p><strong>Files</strong>: <code>app/nexus/internal/net/serve.go</code>, <code>app/keeper/internal/net/serve.go</code></p>
<pre data-lang="go" style="background-color:#2b303b;color:#c0c5ce;" class="language-go "><code class="language-go" data-lang="go"><span style="color:#b48ead;">func </span><span style="color:#8fa1b3;">Serve</span><span>(</span><span style="color:#bf616a;">appName </span><span style="color:#b48ead;">string</span><span>, </span><span style="color:#bf616a;">source </span><span>*</span><span style="color:#bf616a;">workloadapi</span><span>.</span><span style="color:#b48ead;">X509Source</span><span>) {
</span><span>    </span><span style="color:#65737e;">// Fail-fast if source is nil: server cannot operate without mTLS
</span><span>    </span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">source </span><span>== </span><span style="color:#d08770;">nil </span><span>{
</span><span>        </span><span style="color:#bf616a;">log</span><span>.</span><span style="color:#bf616a;">FatalLn</span><span>(
</span><span>            </span><span style="color:#bf616a;">appName</span><span>,
</span><span>            &quot;</span><span style="color:#a3be8c;">message</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">X509 source is nil, cannot start TLS server</span><span>&quot;,
</span><span>        )
</span><span>    }
</span><span>    </span><span style="color:#65737e;">// ... start server
</span><span>}
</span></code></pre>
<p><strong>Rationale</strong>:</p>
<ul>
<li><strong>No retry mechanism</strong>: This is one-time server startup</li>
<li><strong>Cannot function</strong>: Server requires mTLS to operate</li>
<li><strong>Fail-fast is better</strong>: Makes initialization problems immediately obvious</li>
<li><strong>Configuration error</strong>: If nil at startup, it’s a bug that needs immediate
attention</li>
</ul>
<h3 id="retry-gracefully-periodic-recovery-functions">Retry Gracefully (Periodic/Recovery Functions)</h3>
<p><strong>Files</strong>:</p>
<ul>
<li><code>app/nexus/internal/initialization/recovery/recovery.go</code></li>
<li><code>app/spike/internal/cmd/secret/put.go</code></li>
</ul>
<pre data-lang="go" style="background-color:#2b303b;color:#c0c5ce;" class="language-go "><code class="language-go" data-lang="go"><span style="color:#b48ead;">func </span><span style="color:#8fa1b3;">InitializeBackingStoreFromKeepers</span><span>(</span><span style="color:#bf616a;">source </span><span>*</span><span style="color:#bf616a;">workloadapi</span><span>.</span><span style="color:#b48ead;">X509Source</span><span>) {
</span><span>    </span><span style="color:#65737e;">// ...
</span><span>    </span><span style="color:#bf616a;">_</span><span>, </span><span style="color:#bf616a;">err </span><span>:= </span><span style="color:#bf616a;">retry</span><span>.</span><span style="color:#bf616a;">Forever</span><span>(</span><span style="color:#bf616a;">ctx</span><span>, </span><span style="color:#b48ead;">func</span><span>() (</span><span style="color:#b48ead;">bool</span><span>, *</span><span style="color:#bf616a;">sdkErrors</span><span>.</span><span style="color:#b48ead;">SDKError</span><span>) {
</span><span>        </span><span style="color:#65737e;">// Early check: avoid unnecessary function call if source is nil
</span><span>        </span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">source </span><span>== </span><span style="color:#d08770;">nil </span><span>{
</span><span>            </span><span style="color:#bf616a;">log</span><span>.</span><span style="color:#bf616a;">Warn</span><span>(</span><span style="color:#bf616a;">fName</span><span>, &quot;</span><span style="color:#a3be8c;">message</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">X509 source is nil, will retry</span><span>&quot;)
</span><span>            </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">false</span><span>, </span><span style="color:#bf616a;">sdkErrors</span><span>.</span><span style="color:#bf616a;">ErrRecoveryRetryFailed
</span><span>        }
</span><span>        </span><span style="color:#65737e;">// ... attempt recovery
</span><span>    })
</span><span>}
</span></code></pre>
<pre data-lang="go" style="background-color:#2b303b;color:#c0c5ce;" class="language-go "><code class="language-go" data-lang="go"><span style="color:#b48ead;">func </span><span style="color:#8fa1b3;">SendShardsPeriodically</span><span>(</span><span style="color:#bf616a;">source </span><span>*</span><span style="color:#bf616a;">workloadapi</span><span>.</span><span style="color:#b48ead;">X509Source</span><span>) {
</span><span>    </span><span style="color:#b48ead;">for range </span><span style="color:#bf616a;">ticker</span><span>.</span><span style="color:#bf616a;">C </span><span>{
</span><span>        </span><span style="color:#65737e;">// Early check: skip if source is nil
</span><span>        </span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">source </span><span>== </span><span style="color:#d08770;">nil </span><span>{
</span><span>            </span><span style="color:#bf616a;">log</span><span>.</span><span style="color:#bf616a;">Warn</span><span>(</span><span style="color:#bf616a;">fName</span><span>, &quot;</span><span style="color:#a3be8c;">message</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">X509 source is nil: skipping shard send</span><span>&quot;)
</span><span>            </span><span style="color:#b48ead;">continue
</span><span>        }
</span><span>        </span><span style="color:#65737e;">// ... send shards
</span><span>    }
</span><span>}
</span></code></pre>
<p><strong>Rationale</strong>:</p>
<ul>
<li><strong>Retry mechanism exists</strong>: Function runs periodically or in retry loop</li>
<li><strong>Transient failures</strong>: Source might become available later</li>
<li><strong>Graceful degradation</strong>: Log warning and try again</li>
<li><strong>System resilience</strong>: Allows recovery from temporary Workload API issues</li>
</ul>
<h2 id="call-chain-analysis">Call Chain Analysis</h2>
<p>When source is used for server creation, it goes through several layers:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>Serve(source)
</span><span>  ↓
</span><span>net.Serve(source, handler, port)
</span><span>  ↓
</span><span>CreateMTLSServerWithPredicate(source, port, predicate)
</span><span>  ↓ (also checks nil and crashes)
</span><span>MTLSServerConfig(source, source, authorizer)
</span><span>  ↓
</span><span>HookMTLSServerConfig(config, svid, bundle, authorizer)
</span><span>  ↓
</span><span>config.GetCertificate = GetCertificate(svid, opts...)      ← closure captures source
</span><span>config.VerifyPeerCertificate = WrapVerifyPeerCertificate(..., bundle, ...) ← closure captures source
</span></code></pre>
<h3 id="defense-in-depth">Defense in Depth</h3>
<ol>
<li><strong>First check</strong>: <code>Serve()</code> crashes with clear context-specific error</li>
<li><strong>Second check</strong>: <code>CreateMTLSServerWithPredicate()</code> has SDK-level validation</li>
<li><strong>If both missed</strong>: TLS callbacks would crash during handshake (unclear error)</li>
</ol>
<p><strong>Why fail-fast is better</strong>:</p>
<ul>
<li>Clear error at startup: “X509 source is nil, cannot start TLS server”</li>
<li>vs. cryptic panic during first TLS handshake: stack trace with unclear context</li>
</ul>
<h2 id="pointer-stability-in-closures">Pointer Stability in Closures</h2>
<h3 id="how-closures-capture-source">How Closures Capture Source</h3>
<p>When we create the TLS configuration, closures capture the source pointer:</p>
<pre data-lang="go" style="background-color:#2b303b;color:#c0c5ce;" class="language-go "><code class="language-go" data-lang="go"><span style="color:#b48ead;">func </span><span style="color:#8fa1b3;">GetCertificate</span><span>(</span><span style="color:#bf616a;">source </span><span>*</span><span style="color:#bf616a;">workloadapi</span><span>.</span><span style="color:#b48ead;">X509Source</span><span>, </span><span style="color:#bf616a;">opts </span><span>...</span><span style="color:#b48ead;">Option</span><span>) </span><span style="color:#b48ead;">func</span><span>(*</span><span style="color:#bf616a;">tls</span><span>.</span><span style="color:#b48ead;">ClientHelloInfo</span><span>) (*</span><span style="color:#bf616a;">tls</span><span>.</span><span style="color:#b48ead;">Certificate</span><span>, </span><span style="color:#b48ead;">error</span><span>) {
</span><span>    </span><span style="color:#65737e;">// source is captured by the closure below
</span><span>    </span><span style="color:#65737e;">// The closure captures the pointer VALUE (memory address)
</span><span>
</span><span>    </span><span style="color:#b48ead;">return func</span><span>(</span><span style="color:#bf616a;">hello </span><span>*</span><span style="color:#bf616a;">tls</span><span>.</span><span style="color:#b48ead;">ClientHelloInfo</span><span>) (*</span><span style="color:#bf616a;">tls</span><span>.</span><span style="color:#b48ead;">Certificate</span><span>, </span><span style="color:#b48ead;">error</span><span>) {
</span><span>        </span><span style="color:#65737e;">// source can never become nil here because:
</span><span>        </span><span style="color:#65737e;">// 1. The closure captured the pointer value when GetCertificate was called
</span><span>        </span><span style="color:#65737e;">// 2. That captured pointer value is immutable within this closure
</span><span>        </span><span style="color:#65737e;">// 3. Even if someone did `source = nil` elsewhere, this closure&#39;s
</span><span>        </span><span style="color:#65737e;">//    copy of the pointer is unaffected
</span><span>
</span><span>        </span><span style="color:#bf616a;">svid</span><span>, </span><span style="color:#bf616a;">err </span><span>:= </span><span style="color:#bf616a;">source</span><span>.</span><span style="color:#bf616a;">GetX509SVID</span><span>()  </span><span style="color:#65737e;">// Uses the captured pointer
</span><span>        </span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">err </span><span>!= </span><span style="color:#d08770;">nil </span><span>{
</span><span>            </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">nil</span><span>, </span><span style="color:#bf616a;">err
</span><span>        }
</span><span>        </span><span style="color:#b48ead;">return </span><span>&amp;</span><span style="color:#bf616a;">svid</span><span>.</span><span style="color:#bf616a;">Certificates</span><span>[</span><span style="color:#d08770;">0</span><span>], </span><span style="color:#d08770;">nil
</span><span>    }
</span><span>}
</span></code></pre>
<h3 id="key-insights">Key Insights</h3>
<ol>
<li>✅ <code>source</code> points to a concrete initialized struct</li>
<li>✅ The closure captures that pointer value</li>
<li>✅ Inside the closure, <code>source</code> can never be nil (unless it was nil when
captured)</li>
<li>✅ The pointer value is “frozen” in the closure at capture time</li>
</ol>
<p><strong>This is why our nil check at server startup is critical:</strong></p>
<ul>
<li>If <code>source</code> is nil when we create server → closures capture nil → TLS
handshakes crash</li>
<li>If <code>source</code> is valid when we create server → closures capture valid pointer
→ TLS handshakes work</li>
<li>Once captured, the pointer in the closure won’t change to nil later</li>
</ul>
<h2 id="go-error-handling-contract">Go Error Handling Contract</h2>
<h3 id="the-guarantee-pattern">The Guarantee Pattern</h3>
<p>When calling <code>GetX509SVID()</code>, the function contract guarantees safety:</p>
<pre data-lang="go" style="background-color:#2b303b;color:#c0c5ce;" class="language-go "><code class="language-go" data-lang="go"><span style="color:#b48ead;">func </span><span>(</span><span style="color:#bf616a;">s </span><span>*</span><span style="color:#b48ead;">X509Source</span><span>) </span><span style="color:#8fa1b3;">GetX509SVID</span><span>() (*</span><span style="color:#bf616a;">x509svid</span><span>.</span><span style="color:#b48ead;">SVID</span><span>, </span><span style="color:#b48ead;">error</span><span>) {
</span><span>    </span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">err </span><span>:= </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">checkClosed</span><span>(); </span><span style="color:#bf616a;">err </span><span>!= </span><span style="color:#d08770;">nil </span><span>{
</span><span>        </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">nil</span><span>, </span><span style="color:#bf616a;">err
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">mtx</span><span>.</span><span style="color:#bf616a;">RLock</span><span>()
</span><span>    </span><span style="color:#bf616a;">svid </span><span>:= </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">svid
</span><span>    </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">mtx</span><span>.</span><span style="color:#bf616a;">RUnlock</span><span>()
</span><span>
</span><span>    </span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">svid </span><span>== </span><span style="color:#d08770;">nil </span><span>{
</span><span>        </span><span style="color:#65737e;">// Defensive check - should be unreachable
</span><span>        </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">nil</span><span>, </span><span style="color:#bf616a;">wrapX509sourceErr</span><span>(</span><span style="color:#bf616a;">errors</span><span>.</span><span style="color:#bf616a;">New</span><span>(&quot;</span><span style="color:#a3be8c;">missing X509-SVID</span><span>&quot;))
</span><span>    }
</span><span>    </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">svid</span><span>, </span><span style="color:#d08770;">nil
</span><span>}
</span></code></pre>
<p><strong>Three possible return paths:</strong></p>
<ol>
<li><strong>Closed source</strong>: <code>return nil, err</code></li>
<li><strong>Missing SVID</strong>: <code>return nil, error</code></li>
<li><strong>Success</strong>: <code>return svid, nil</code> (guaranteed non-nil)</li>
</ol>
<p><strong>Usage pattern:</strong></p>
<pre data-lang="go" style="background-color:#2b303b;color:#c0c5ce;" class="language-go "><code class="language-go" data-lang="go"><span style="color:#bf616a;">svid</span><span>, </span><span style="color:#bf616a;">err </span><span>:= </span><span style="color:#bf616a;">source</span><span>.</span><span style="color:#bf616a;">GetX509SVID</span><span>()
</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">err </span><span>!= </span><span style="color:#d08770;">nil </span><span>{
</span><span>    </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">nil</span><span>, </span><span style="color:#bf616a;">err  </span><span style="color:#65737e;">// Don&#39;t use svid!
</span><span>}
</span><span style="color:#65737e;">// If we&#39;re here, err == nil, which means svid is GUARANTEED to be non-nil
</span><span style="color:#bf616a;">use</span><span>(</span><span style="color:#bf616a;">svid</span><span>)  </span><span style="color:#65737e;">// Safe!
</span></code></pre>
<p><strong>The guarantee</strong>: You can never get <code>(nil, nil)</code> from this function. You
either get:</p>
<ul>
<li><code>(nil, error)</code> - don’t use the SVID</li>
<li><code>(*x509svid.SVID, nil)</code> - SVID is guaranteed non-nil</li>
</ul>
<h2 id="concurrency-and-memory-model">Concurrency and Memory Model</h2>
<h3 id="the-question">The Question</h3>
<p>Can <code>svid</code> become nil between the check and the return?</p>
<pre data-lang="go" style="background-color:#2b303b;color:#c0c5ce;" class="language-go "><code class="language-go" data-lang="go"><span style="color:#b48ead;">if </span><span style="color:#bf616a;">svid </span><span>== </span><span style="color:#d08770;">nil </span><span>{
</span><span>    </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">nil</span><span>, </span><span style="color:#bf616a;">wrapX509sourceErr</span><span>(</span><span style="color:#bf616a;">errors</span><span>.</span><span style="color:#bf616a;">New</span><span>(&quot;</span><span style="color:#a3be8c;">missing X509-SVID</span><span>&quot;))
</span><span>}
</span><span style="color:#65737e;">// ← Could another goroutine set svid = nil here?
</span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">svid</span><span>, </span><span style="color:#d08770;">nil
</span></code></pre>
<h3 id="the-answer-no">The Answer: No</h3>
<p><strong>Because of how the code is structured:</strong></p>
<pre data-lang="go" style="background-color:#2b303b;color:#c0c5ce;" class="language-go "><code class="language-go" data-lang="go"><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">mtx</span><span>.</span><span style="color:#bf616a;">RLock</span><span>()
</span><span style="color:#bf616a;">svid </span><span>:= </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">svid  </span><span style="color:#65737e;">// ← Creates a LOCAL COPY of the pointer
</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">mtx</span><span>.</span><span style="color:#bf616a;">RUnlock</span><span>()
</span><span>
</span><span style="color:#65737e;">// From here on, `svid` is a local variable on this goroutine&#39;s stack
</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">svid </span><span>== </span><span style="color:#d08770;">nil </span><span>{
</span><span>    </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">nil</span><span>, </span><span style="color:#bf616a;">wrapX509sourceErr</span><span>(</span><span style="color:#bf616a;">errors</span><span>.</span><span style="color:#bf616a;">New</span><span>(&quot;</span><span style="color:#a3be8c;">missing X509-SVID</span><span>&quot;))
</span><span>}
</span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">svid</span><span>, </span><span style="color:#d08770;">nil  </span><span style="color:#65737e;">// Returning the local copy
</span></code></pre>
<h3 id="why-svid-cannot-become-nil">Why <code>svid</code> Cannot Become Nil</h3>
<ol>
<li><strong><code>svid</code> is a local variable</strong> (stack-allocated, goroutine-private)</li>
<li><strong>It’s a copy of the pointer value</strong> made while holding the read lock</li>
<li><strong>Other goroutines can modify <code>s.svid</code></strong> (the struct field), but <strong>NOT this
local <code>svid</code> variable</strong></li>
<li><strong>Go’s memory model guarantees</strong> that local variables are private to the
goroutine’s stack frame</li>
</ol>
<h3 id="memory-model-diagram">Memory Model Diagram</h3>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>Heap:                          Stack (your goroutine):
</span><span>┌─────────────────┐           ┌──────────────────┐
</span><span>│  SVID struct    │ ←─────────│ svid (pointer)   │ (local copy)
</span><span>│  {data...}      │ ↖         └──────────────────┘
</span><span>└─────────────────┘  │
</span><span>                     │
</span><span>X509Source:          │
</span><span>┌─────────────────┐  │
</span><span>│ svid (pointer)  │──┘ (can be modified by other goroutines)
</span><span>└─────────────────┘
</span></code></pre>
<p><strong>What’s happening:</strong></p>
<ol>
<li>✅ There’s a concrete <code>SVID</code> struct somewhere in memory</li>
<li>✅ <code>s.svid</code> is already a pointer to that struct (type <code>*x509svid.SVID</code>)</li>
<li>✅ <code>svid := s.svid</code> <strong>copies the pointer value</strong> (the address)</li>
<li>✅ Now you have a <strong>local copy of the address</strong> (the pointer value)</li>
<li>✅ Both <code>s.svid</code> and your local <code>svid</code> point to the <strong>same concrete struct</strong></li>
<li>✅ GC won’t deallocate the struct because there’s at least one reference to
it</li>
<li>✅ Your local <code>svid</code> is stack-local - other goroutines can’t modify it</li>
<li>✅ You return that pointer, guaranteed to be non-nil (if it passed the check)</li>
</ol>
<h3 id="go-s-guarantees">Go’s Guarantees</h3>
<ul>
<li><strong>Local variables are goroutine-private</strong>: Each goroutine has its own stack</li>
<li><strong>Copying a pointer copies the address value</strong>: Atomic on all Go architectures</li>
<li><strong>Other goroutines can’t modify your stack frame</strong>: Memory isolation</li>
<li><strong>The pointer value is immutable after the copy</strong>: Unless you reassign it in
the same goroutine</li>
</ul>
<h3 id="the-incorrect-pattern-don-t-do-this">The Incorrect Pattern (Don’t Do This)</h3>
<pre data-lang="go" style="background-color:#2b303b;color:#c0c5ce;" class="language-go "><code class="language-go" data-lang="go"><span style="color:#65737e;">// UNSAFE - DON&#39;T DO THIS
</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">mtx</span><span>.</span><span style="color:#bf616a;">RLock</span><span>()
</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">svid </span><span>== </span><span style="color:#d08770;">nil </span><span>{  </span><span style="color:#65737e;">// Checking the shared field
</span><span>    </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">mtx</span><span>.</span><span style="color:#bf616a;">RUnlock</span><span>()
</span><span>    </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">nil</span><span>, </span><span style="color:#bf616a;">error
</span><span>}
</span><span style="color:#65737e;">// ← Another goroutine could set s.svid = nil here!
</span><span style="color:#bf616a;">result </span><span>:= </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">svid
</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">mtx</span><span>.</span><span style="color:#bf616a;">RUnlock</span><span>()
</span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">result</span><span>, </span><span style="color:#d08770;">nil  </span><span style="color:#65737e;">// Could return nil!
</span></code></pre>
<h3 id="the-correct-pattern-what-it-actually-does">The Correct Pattern (What It Actually Does)</h3>
<pre data-lang="go" style="background-color:#2b303b;color:#c0c5ce;" class="language-go "><code class="language-go" data-lang="go"><span style="color:#65737e;">// SAFE - this is what it actually does
</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">mtx</span><span>.</span><span style="color:#bf616a;">RLock</span><span>()
</span><span style="color:#bf616a;">svid </span><span>:= </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">svid  </span><span style="color:#65737e;">// Atomic copy under lock
</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">mtx</span><span>.</span><span style="color:#bf616a;">RUnlock</span><span>()
</span><span style="color:#65737e;">// Now working with local copy - other goroutines can&#39;t touch it
</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">svid </span><span>== </span><span style="color:#d08770;">nil </span><span>{
</span><span>    </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">nil</span><span>, </span><span style="color:#bf616a;">error
</span><span>}
</span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">svid</span><span>, </span><span style="color:#d08770;">nil  </span><span style="color:#65737e;">// Guaranteed non-nil
</span></code></pre>
<h2 id="summary">Summary</h2>
<h3 id="nil-source-handling-strategy">Nil Source Handling Strategy</h3>
<table><thead><tr><th>Context</th><th>Strategy</th><th>Rationale</th></tr></thead><tbody>
<tr><td><strong>Server Startup</strong></td><td>Crash with <code>log.FatalLn</code></td><td>No retry mechanism; fail-fast makes problems obvious</td></tr>
<tr><td><strong>Retry Loops</strong></td><td>Warn and retry</td><td>Transient failures; source might recover</td></tr>
<tr><td><strong>Periodic Functions</strong></td><td>Warn and skip iteration</td><td>Source might become available in next cycle</td></tr>
<tr><td><strong>CLI Commands</strong></td><td>Print error and exit cleanly</td><td>User-facing; clear error message</td></tr>
</tbody></table>
<h3 id="key-takeaways">Key Takeaways</h3>
<ol>
<li><strong>Defense in depth</strong>: Multiple layers of nil checks throughout the call chain</li>
<li><strong>Fail-fast at startup</strong>: Crash immediately if server can’t function</li>
<li><strong>Graceful degradation in loops</strong>: Warn and retry for transient failures</li>
<li><strong>Pointer stability</strong>: Closures capture pointer values safely</li>
<li><strong>Go’s error contract</strong>: If <code>err == nil</code>, return value is guaranteed valid</li>
<li><strong>Memory model</strong>: Local variables are goroutine-private</li>
<li><strong>Atomic pointer copies</strong>: Safe under mutex protection</li>
</ol>
<h3 id="final-wisdom">Final Wisdom</h3>
<p><strong>Check nil at startup, crash early, sleep well at night!</strong> ✓</p>
<p>The combination of defensive nil checks, proper error handling, and Go’s memory
model guarantees ensures that SPIKE handles source invalidation safely across
all operational contexts.</p>

    
        </article>

        <footer id="footer">
            Copyright © 2024-present <strong>SPIKE Contributors</strong>.<br>
            <strong>SPIKE</strong>'s code
            is distributed under <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache (v2.0)</a>.
            <br>
            The documentation on this website
            is distributed under <a href="https://creativecommons.org/licenses/by/4.0/">CC-BY-4.0</a>.
            <br><br>
            We <strong>do not</strong> collect your data.
            This site <strong>does not</strong> use any tracking cookies or scripts.
        </footer>
    </div>

</main>


    <script type="text/javascript" src="https://spike.ist/elasticlunr.min.js" defer></script>
    <script type="text/javascript" src="https://spike.ist/search_index.en.js" defer></script>
<script type="text/javascript" src="https://spike.ist/js.js" defer></script>
</body>
</html>
<style>
body {
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0;
    font-family: var(--font-family);
    background-color: var(--bg-primary);
    color: var(--text-primary);
}

main {
    width: 100vw;
    max-width: 1920px;
    display: flex;
    flex-direction: row;
    overflow: hidden;
}

#footer {
    text-align: center;
    padding: 2rem;
    font-size: 0.875rem;
    color: var(--text-muted);
    border-top: 1px solid var(--border-color);
    margin-top: 2rem;
}

.content {
    display: flex;
    flex-direction: column;
    flex: 1;
    height: 100vh;
    overflow-y: auto;
    background-color: var(--bg-primary);
    line-height: 1.6;
    border-left: 1px solid var(--border-color);
}

#footer a {
    color: var(--spike-blue);
    text-decoration: none;
    transition: all 0.2s ease;
    border-bottom: 1px solid transparent;
    font-weight: 500;

}

#footer a:hover {
    border-bottom-color: var(--spike-blue);
}

</style>