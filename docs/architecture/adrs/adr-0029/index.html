<!DOCTYPE HTML>
<html>
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/main.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="icon" href="https://spike.ist/assets/spike-favicon-16x16.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <title> SPIKE | ADR-0029: Restrict Recovery and Restoration Operations to SPIKE Pilot </title>
</head>
<body>

<main>
    
    <nav>
  <script>
    fetch('https://api.github.com/repos/spiffe/spike/releases/latest')
        .then(response => response.json())
        .then(data => {
            const release = document.getElementById('release');
            const icon = '<i class="bx bx-package"></i>';
            release.href = data.name ? data.html_url : 'https://api.github.com/repos/spiffe/spike/releases';
            release.innerHTML = icon + (data.name ? ' ' + data.name : ' Releases');
        });
</script>
<div id="banner">
    <a href="https://spike.ist">
        <img id="banner-image" src="https://spike.ist/assets/spike-banner.png" alt="logo" />
    </a>
    <div id="banner-body">
        <a class="banner-title" href="https://spike.ist">
            SPIKE
        </a>
        <span class="banner-tagline">
            Secure your secrets<br> with SPIFFE.
        </span>
        <a id="release" class="banner-link" href="https://github.com/spiffe/spike/releases">
            <i class='bx bx-package'></i>
        </a>
        <a href="https://github.com/spiffe/spike" class="banner-link">
            <i class='bx bxl-github'></i> GitHub
        </a>

    </div>
</div>
<style>
   /* Banner on top of the nav */
   #banner {
        position: sticky;
        background-color: var(--bg-primary);
        z-index: 100;
        top: 0;
        display: flex;
        flex-direction: row;
        padding: 1rem;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        margin-bottom: 1rem;
    }

    #banner img {
        width: 100px;
        height: auto;
    }

    #banner-body {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        justify-content: space-between;
        margin-left: 1rem;
    }

    .banner-title {
        font-size: 1.75rem;
        font-weight: 700;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        margin-bottom: -15px;
        font-family: var(--brand-font-family);
    }
    .banner-tagline {
        font-size: 0.875rem;
        color: var(--text-muted);
        font-style: italic;
    }

    .banner-link {
        display: flex;
        gap: 0.5rem;
        min-width: 84px;
        font-size: 0.875rem;
        font-weight: 300;
        padding: 0.25rem 0.75rem;
        border-radius: 4px;
        background-color: var(--bg-interactive);
        transition: all 0.2s ease;
    }

    .banner-link i {
        font-size: 1.125rem;
        color: var(--spike-blue);
    }

    .banner-link:hover {
        background-color: var(--spike-blue);
    }
</style> <div id="trees">
    <input class="tree-toggle" type="checkbox" id="about"
               />
        <label class="tree-toggle-label "
               for="about">About</label>

        <ul class="subtree">
            <li >
                    <a href="https://spike.ist/about/intro/">About SPIKE</a>
                </li>

                <li >
                    <a href="https://spike.ist/about/project-status/">Project Maturity</a>
                </li>

                </ul>
    <input class="tree-toggle" type="checkbox" id="community"
               />
        <label class="tree-toggle-label "
               for="community">Community</label>

        <ul class="subtree">
            <li >
                    <a href="https://spike.ist/community/hello/">Hello Universe</a>
                </li>

                <li >
                    <a href="https://spike.ist/community/contact/">Contact Us</a>
                </li>

                <li >
                    <a href="https://spike.ist/community/presentations/">Presentations and Demos</a>
                </li>

                <li >
                    <a href="https://spike.ist/community/resources/">Resources</a>
                </li>

                </ul>
    <input class="tree-toggle" type="checkbox" id="getting-started"
               />
        <label class="tree-toggle-label "
               for="getting-started">Getting Started</label>

        <ul class="subtree">
            <li >
                    <a href="https://spike.ist/getting-started/quickstart/">SPIKE Quickstart Guide</a>
                </li>

                </ul>
    <input class="tree-toggle" type="checkbox" id="using-spike"
               />
        <label class="tree-toggle-label "
               for="using-spike">Using SPIKE</label>

        <ul class="subtree">
            <li >
                    <a href="https://spike.ist/usage/configuration/">Configuring SPIKE</a>
                </li>

                <li >
                    <a href="https://spike.ist/usage/cli/">SPIKE CLI</a>
                </li>

                </ul>
    <input class="tree-toggle" type="checkbox" id="developing-spike"
               />
        <label class="tree-toggle-label "
               for="developing-spike">Developing SPIKE</label>

        <ul class="subtree">
            <li >
                    <a href="https://spike.ist/development/local-deployment/">SPIKE on Kubernetes</a>
                </li>

                <li >
                    <a href="https://spike.ist/development/bare-metal/">SPIKE on Linux</a>
                </li>

                <li >
                    <a href="https://spike.ist/development/api-docs/">API Documentation</a>
                </li>

                </ul>
    <input class="tree-toggle" type="checkbox" id="spike-architecture"
               checked/>
        <label class="tree-toggle-label "
               for="spike-architecture">SPIKE Architecture</label>

        <ul class="subtree">
            <li >
                    <a href="https://spike.ist/architecture/system-overview/">System Overview</a>
                </li>

                <li >
                    <a href="https://spike.ist/architecture/security-model/">SPIKE Security Model</a>
                </li>

                <li >
                    <a href="https://spike.ist/architecture/architectural-decision-records/">ADRs</a>
                </li>

                </ul>
    <input class="tree-toggle" type="checkbox" id="tracking"
               />
        <label class="tree-toggle-label "
               for="tracking">Tracking</label>

        <ul class="subtree">
            <li >
                    <a href="https://spike.ist/tracking/changelog/">Changelog</a>
                </li>

                <li >
                    <a href="https://spike.ist/tracking/snapshots/">Documentation Snapshots</a>
                </li>

                </ul>
    <input class="tree-toggle" type="checkbox" id="operations"
               />
        <label class="tree-toggle-label "
               for="operations">Operations</label>

        <ul class="subtree">
            <li >
                    <a href="https://spike.ist/operations/build/">SPIKE Cross-Platform Build</a>
                </li>

                <li >
                    <a href="https://spike.ist/operations/production/">SPIKE Production Setup</a>
                </li>

                <li >
                    <a href="https://spike.ist/operations/recovery/">SPIKE Recovery Procedures</a>
                </li>

                <li >
                    <a href="https://spike.ist/operations/backup/">SPIKE Backup and Restore</a>
                </li>

                <li >
                    <a href="https://spike.ist/operations/release/">SPIKE Relase Management</a>
                </li>

                </ul>
    </div>
<style>
    /* Navigation tree structure */
    #trees {
        padding: 0 1rem;
    }

    .tree-toggle {
        display: none;
    }

    .tree-toggle:checked + .tree-toggle-label + .subtree {
        display: block;
    }

    .tree-toggle-label {
        display: block;
        padding: 0.75rem 1rem;
        margin: 0.25rem 0;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .tree-toggle-label:hover {
        background-color: rgba(0, 0, 0, 0.05);
    }

    .tree-toggle-label::before {
        content: '▸';
        display: inline-block;
        margin-right: 0.5rem;
        transition: transform 0.2s ease;
    }

    .tree-toggle:checked + .tree-toggle-label::before {
        transform: rotate(90deg);
    }

    .subtree {
        display: none;
        margin: 0;
        padding: 0 0 0 1rem;
        list-style: none;
    }

    .subtree li {
        margin: 0.25rem 0;
    }

    .subtree li a {
        display: block;
        padding: 0.5rem 1rem;
        text-decoration: none;
        border-radius: 4px;
        font-size: 0.9375rem;
        transition: all 0.2s ease;
    }

    .subtree li a:hover {
        background-color: rgba(0, 0, 0, 0.05);
    }

    .subtree li.active a {
        font-weight: 600;
        background-color: rgba(0, 0, 0, 0.05);
    }

    /* Table of contents styling */
    #toc {
        margin: 0.5rem 0 0.5rem 1.5rem;
        padding: 0;
        list-style: none;
        font-size: 0.875rem;
    }

    #toc li {
        margin: 0.25rem 0;
    }

    #toc li a {
        padding: 0.375rem 0.75rem;
        opacity: 0.8;
    }

    #toc li a:hover {
        opacity: 1;
    }

    #toc ul {
        margin: 0.25rem 0 0.25rem 1rem;
        padding: 0;
        list-style: none;
    }
</style>
</nav>
<style>
  nav {
    position: sticky;
    width: 300px;
    height: 100vh;
    top: 0;
    max-height: 100vh;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: rgba(0, 0, 0, 0.3) transparent;
    z-index: 100;
    box-shadow: 5px 0 20px var(--shadow-color);
    border-right: 1px solid var(--border-color);
    transition: transform 0.4s ease-in-out;
    background-color: var(--bg-primary);
  }

  nav::-webkit-scrollbar {
    width: 8px;
  }

  nav::-webkit-scrollbar-track {
    background: transparent;
  }

  nav::-webkit-scrollbar-thumb {
    background-color: rgba(0, 0, 0, 0.3);
    border-radius: 4px;
    border: 2px solid transparent;
  }

  @media (max-width: 1300px) {
    .nav-toggle {
      display: none;
    }

    nav {
      position: fixed;
      transform: translateX(-100%);
      width: 85%;
      max-width: 300px;
      height: calc(100vh - 57px);
      top: 57px;
    }

    nav.active {
      transform: translateX(0);
    }
  }
</style>


    <div class="content">
        <div class="header">
  <div class="header-content">
    <button
      id="mobile-nav-toggle"
      aria-label="Toggle navigation"
      class="mobile-only"
    >
      <i class="bx bx-menu"></i>
    </button>
    <script>
  document.addEventListener("DOMContentLoaded", () => {
    const searchInput = document.querySelector(".search-input");
    const overlay = document.querySelector(".overlay");
    const searchResults = document.querySelector(".search-results");

    function closeSearch() {
      overlay.style.display = "none";
      searchResults.style.display = "none";
      searchInput.blur();
    }

    function openSearch() {
      overlay.style.display = "block";
      searchResults.style.display = "block";
    }

    searchInput.addEventListener("focus", openSearch);
    overlay.addEventListener("click", closeSearch);
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        closeSearch();
      }
    });
  });
</script>
<div class="overlay"></div>
<input class="search-input" type="text" placeholder="Search..." />
<div class="search-results">
  <div class="search-results__header">
    <span class="search-results__count">Waiting for input...</span>
  </div>
  <div class="search-results__items"></div>
</div>

<style>
  .search-input {
    width: 100%;
    padding: 0.5rem 1rem;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background-color: var(--bg-interactive);
    color: var(--text-primary);
    font-size: 0.875rem;
    transition: all 0.2s ease;
    z-index: 101;
  }

  .search-input:focus {
    outline: none;
    border-color: var(--spike-blue);
    background-color: var(--bg-primary);
    box-shadow: 0 0 0 2px rgba(var(--spike-blue-rgb), 0.2);
  }

  .search-input::placeholder {
    color: var(--text-muted);
  }

  .overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 100;
  }

  .search-results {
    display: none;
    position: absolute;
    left: 0;
    right: 0;
    top: 100%;
    max-width: 700px;
    margin: 0.5rem auto;
    background: var(--bg-primary);
    border-radius: 8px;
    box-shadow: 0px 4px 8px 3px rgba(0, 0, 0, 0.1);
    border: 1px solid var(--border-color);
    z-index: 102;
  }

  .search-results__header {
    padding: 0.75rem 1rem;
    color: var(--text-muted);
    font-size: 0.875rem;
    border-bottom: 1px solid var(--border-color);
  }

  .search-results__items {
    max-height: 60vh;
    overflow-y: auto;
  }

  .search-results__item {
    display: block;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border-color);
    transition: background-color 0.2s ease;
  }

  .search-results__item:hover {
    background-color: var(--bg-interactive);
  }

  .search-results__title {
    color: var(--spike-blue);
    font-size: 0.875rem;
    font-weight: 500;
    margin-bottom: 0.25rem;
  }

  .search-results__preview {
    color: var(--text-secondary);
    font-size: 0.8125rem;
    line-height: 1.4;
  }

  .search-results__preview b {
    color: var(--spike-dark-green);
    font-weight: 600;
  }

  .search-results__items::-webkit-scrollbar {
    width: 4px;
  }

  .search-results__items::-webkit-scrollbar-thumb {
    background: var(--border-color);
    border-radius: 4px;
  }

  /* Empty state */
  .search-results__empty {
    padding: 2rem 1rem;
    text-align: center;
    color: var(--text-muted);
    font-size: 0.875rem;
  }
</style>

    <a
      href="https://github.com/spiffe/spike"
      target="_blank"
      rel="noopener"
      class="github-star"
    >
      <i class="bx bx-star"></i>
      <span>Star <strong>SPIKE</strong> on <strong>GitHub</strong></span>
    </a>
    <button id="theme-toggle" aria-label="Toggle theme">
      <i class="bx bx-sun light-icon"></i>
      <i class="bx bx-moon dark-icon"></i>
    </button>
  </div>
</div>

<style>
  .header {
    position: sticky;
    top: 0;
    background-color: var(--bg-primary);
    padding: 1rem;
    border-bottom: 1px solid var(--border-color);
    box-shadow: 0 4px 6px -1px var(--shadow-color),
      0 2px 4px -1px var(--shadow-color);
    z-index: 101;
  }

  .header-content {
    max-width: 800px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  #mobile-nav-toggle {
    display: none;
    background: none;
    border: none;
    padding: 0.5rem;
    cursor: pointer;
    color: var(--text-primary);
    font-size: 1.5rem;
    border-radius: 4px;
    transition: all 0.2s ease;
  }

  #mobile-nav-toggle i {
    pointer-events: none;
    display: block;
  }

  #mobile-nav-toggle:hover {
    background-color: var(--bg-interactive);
  }

  @media (max-width: 1300px) {
    #mobile-nav-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
    }
  }

  #theme-toggle {
    background: none;
    border: none;
    padding: 0.5rem;
    cursor: pointer;
    color: var(--text-primary);
    font-size: 1.25rem;
    border-radius: 4px;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  #theme-toggle:hover {
    background-color: var(--bg-interactive);
  }

  #theme-toggle:active {
    background-color: var(--bg-secondary);
  }

  /* Show/hide icons based on theme */
  [data-theme="dark"] .light-icon,
  :root:not([data-theme="dark"]) .dark-icon {
    display: none;
  }

  /* GitHub Star Button */
  .github-star {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    color: white;
    text-decoration: none;
    background: linear-gradient(
      135deg,
      var(--spike-blue),
      var(--spike-dark-green)
    );
    border-radius: 20px;
    transition: all 0.2s ease;
    font-size: 0.875rem;
    white-space: nowrap;
  }

  .github-star:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(var(--spike-blue-rgb), 0.3);
  }

  .github-star i {
    font-size: 1.1rem;
    animation: starBounce 2s infinite;
    color: #ffd700;
    text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
  }

  @keyframes starBounce {
    0%,
    100% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.2);
    }
  }

  .github-star span {
    white-space: nowrap;
  }

  @media (max-width: 768px) {
    .github-star span {
      display: none;
    }

    .github-star {
      padding: 0.5rem;
    }
  }
</style>

<script>
  // Theme toggle functionality
  document.addEventListener("DOMContentLoaded", () => {
    const themeToggle = document.getElementById("theme-toggle");

    // Function to set theme
    function setTheme(theme) {
      document.documentElement.setAttribute("data-theme", theme);
      localStorage.setItem("theme", theme);
      
      // Update banner image based on theme
      const bannerImage = document.getElementById("banner-image");
      if (bannerImage) {
        bannerImage.src = theme === "dark" 
          ? "/assets/spike-banner-dark-thin.png"
          : "/assets/spike-banner-light-thin.png";
      }
    }

    // Initialize theme
    const savedTheme = localStorage.getItem("theme");
    setTheme(savedTheme ? savedTheme : "dark");
    // Discard system theme changes; the landing page is always dark, so
    // it's better to transition to a dark-by-default theme.
    // } else if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
    //   setTheme("dark");
    // }

    // Toggle theme on button click
    themeToggle.addEventListener("click", () => {
      const currentTheme = document.documentElement.getAttribute("data-theme");
      const newTheme = currentTheme === "dark" ? "light" : "dark";
      setTheme(newTheme);
    });

    // Discard system-theme changes.
    // window
    //   .matchMedia("(prefers-color-scheme: dark)")
    //   .addEventListener("change", (e) => {
    //     if (!localStorage.getItem("theme")) {
    //       setTheme(e.matches ? "dark" : "light");
    //     }
    //   });
  });
</script>


        <article>
            
        <h1 id="adr-0029-restrict-recovery-and-restoration-operations-to-spike-pilot">ADR-0029: Restrict Recovery and Restoration Operations to SPIKE Pilot</h1>
<br style="clear:both" />
<ul>
<li>Status: accepted</li>
<li>Date: 2025-11-19</li>
<li>Tags: Security, Recovery, Access Control, SPIFFE</li>
</ul>
<h2 id="context">Context</h2>
<p>SPIKE provides various operations that workloads can perform against SPIKE Nexus,
including secret management (get, put, delete), policy management, and critical
recovery operations (recover, restore). Most operations can be controlled through
SPIKE’s policy system, allowing fine-grained access control based on SPIFFE IDs
and other attributes.</p>
<p>However, recovery and restoration operations are <strong>fundamentally different</strong>
from regular operations:</p>
<ol>
<li><strong>Recovery</strong> initiates the process of retrieving Shamir secret shards when
SPIKE Nexus needs to be restored from a catastrophic failure</li>
<li><strong>Restoration</strong> submits these shards back to rebuild the root encryption key</li>
</ol>
<p>These operations bypass normal secret access policies and directly manipulate
the root cryptographic material that protects the entire secrets store. If
compromised, an attacker could potentially decrypt all secrets in the system.</p>
<p>We need to determine the appropriate access control mechanism for these
critical recovery operations.</p>
<h2 id="decision">Decision</h2>
<p>Recovery (<code>Recover</code>) and restoration (<code>Restore</code>) operations will be <strong>restricted
exclusively to SPIKE Pilot</strong> at the SDK level, enforced through SPIFFE ID
validation.</p>
<p>Specifically:</p>
<ul>
<li>The SDK will check the caller’s SPIFFE ID using <code>spiffeid.IsPilot()</code></li>
<li>Only workloads identified as SPIKE Pilot may invoke these operations</li>
<li>Violations will result in immediate fatal termination via <code>log.FatalErr()</code></li>
<li>This restriction is <strong>not</strong> configurable through policies</li>
</ul>
<p>All other operations (secrets, policies, cipher, ACLs) remain policy-controlled
and can be authorized for any workload based on configured policies.</p>
<h2 id="rationale">Rationale</h2>
<h3 id="security-criticality-hierarchy">Security Criticality Hierarchy</h3>
<p>SPIKE operations fall into different security tiers:</p>
<table><thead><tr><th>Operation Type</th><th>Security Impact</th><th>Access Control</th></tr></thead><tbody>
<tr><td>Secret read/write</td><td>Medium - affects individual secrets</td><td>Policy-based</td></tr>
<tr><td>Policy management</td><td>High - affects access control</td><td>Policy-based</td></tr>
<tr><td>Cipher operations</td><td>Medium - encryption/decryption</td><td>Policy-based</td></tr>
<tr><td><strong>Recovery/Restore</strong></td><td><strong>Critical - affects entire system</strong></td><td><strong>Hard-coded</strong></td></tr>
</tbody></table>
<h3 id="why-recovery-operations-are-different">Why Recovery Operations Are Different</h3>
<p><strong>Policy-controlled operations</strong> (secrets, policies, etc.):</p>
<ul>
<li>Operate within the normal secret access control framework</li>
<li>Failure affects specific secrets or policies</li>
<li>Can be safely delegated to various workloads</li>
<li>Policy misconfiguration has limited blast radius</li>
</ul>
<p><strong>Recovery operations</strong> (recover, restore):</p>
<ul>
<li>Bypass all policy controls and access root cryptographic material</li>
<li>Failure or compromise could decrypt <strong>all secrets</strong> in the system</li>
<li>Should only be performed during disaster recovery scenarios</li>
<li>Must have the smallest possible attack surface</li>
<li>Policy-based control would create circular dependency (policies are protected
by the key being recovered)</li>
</ul>
<h3 id="defense-in-depth">Defense in Depth</h3>
<p>While SPIKE Nexus itself validates recovery requests, enforcing the restriction
at the SDK level provides defense in depth:</p>
<ol>
<li><strong>SDK enforcement</strong>: Prevents unauthorized workloads from attempting recovery</li>
<li><strong>Nexus enforcement</strong>: Final validation even if SDK is bypassed</li>
<li><strong>SPIFFE authentication</strong>: Cryptographically verifiable identity</li>
<li><strong>Audit trail</strong>: Fatal errors logged when violations occur</li>
</ol>
<h3 id="spiffe-identity-as-strong-authentication">SPIFFE Identity as Strong Authentication</h3>
<p>SPIKE Pilot’s SPIFFE ID is:</p>
<ul>
<li>Cryptographically verified through mTLS</li>
<li>Issued by the trusted SPIRE server</li>
<li>Cannot be spoofed or stolen without compromising the SPIRE trust domain</li>
<li>Provides stronger authentication than password-based or API key approaches</li>
</ul>
<h3 id="fail-safe-design">Fail-Safe Design</h3>
<p>The SDK implementation uses <code>log.FatalErr()</code> rather than returning an error:</p>
<pre data-lang="go" style="background-color:#2b303b;color:#c0c5ce;" class="language-go "><code class="language-go" data-lang="go"><span style="color:#b48ead;">if </span><span>!</span><span style="color:#bf616a;">spiffeid</span><span>.</span><span style="color:#bf616a;">IsPilot</span><span>(</span><span style="color:#bf616a;">selfSPIFFEID</span><span>) {
</span><span>    </span><span style="color:#bf616a;">failErr </span><span>:= </span><span style="color:#bf616a;">sdkErrors</span><span>.</span><span style="color:#bf616a;">ErrUnauthorized
</span><span>    </span><span style="color:#bf616a;">failErr</span><span>.</span><span style="color:#bf616a;">Msg </span><span>= &quot;</span><span style="color:#a3be8c;">recovery can only be performed from SPIKE Pilot</span><span>&quot;
</span><span>    </span><span style="color:#bf616a;">log</span><span>.</span><span style="color:#bf616a;">FatalErr</span><span>(</span><span style="color:#bf616a;">fName</span><span>, *</span><span style="color:#bf616a;">failErr</span><span>)
</span><span>}
</span></code></pre>
<p>This ensures:</p>
<ul>
<li>No possibility of error handling bugs bypassing the check</li>
<li>Clear audit trail in logs</li>
<li>Immediate termination prevents any further processing</li>
<li>Aligns with security-critical failure handling (similar to key length
validation failures)</li>
</ul>
<h2 id="alternatives-considered">Alternatives Considered</h2>
<h3 id="alternative-1-policy-based-control">Alternative 1: Policy-Based Control</h3>
<p>Allow recovery operations to be controlled through the policy system like other
operations.</p>
<p><strong>Rejected because:</strong></p>
<ul>
<li>Creates circular dependency: policies are protected by the key being recovered</li>
<li>During disaster recovery, policy system may not be available</li>
<li>Increases attack surface unnecessarily</li>
<li>Policy misconfiguration could enable unauthorized recovery</li>
</ul>
<h3 id="alternative-2-no-sdk-enforcement">Alternative 2: No SDK Enforcement</h3>
<p>Rely solely on SPIKE Nexus to validate recovery requests.</p>
<p><strong>Rejected because:</strong></p>
<ul>
<li>Violates defense-in-depth principle</li>
<li>Allows unauthorized attempts to reach Nexus unnecessarily</li>
<li>Reduces audit trail granularity</li>
<li>Bypasses early-fail security principle</li>
</ul>
<h3 id="alternative-3-configuration-based-control">Alternative 3: Configuration-Based Control</h3>
<p>Make the allowed SPIFFE IDs configurable via environment variables or config
files.</p>
<p><strong>Rejected because:</strong></p>
<ul>
<li>Configuration errors could accidentally enable unauthorized access</li>
<li>Increases operational complexity</li>
<li>Provides no real benefit (recovery should always be from Pilot)</li>
<li>Configuration-based security is generally weaker than hard-coded for critical
operations</li>
</ul>
<h2 id="consequences">Consequences</h2>
<h3 id="positive">Positive</h3>
<ul>
<li><strong>Reduced attack surface</strong>: Only SPIKE Pilot can initiate recovery operations</li>
<li><strong>Defense in depth</strong>: Multiple layers of validation (SDK + Nexus)</li>
<li><strong>Fail-safe</strong>: Fatal errors prevent accidental bypasses</li>
<li><strong>Clear security model</strong>: Critical operations have stricter controls than
regular operations</li>
<li><strong>Audit trail</strong>: Failed attempts are logged with context</li>
<li><strong>No configuration complexity</strong>: No additional configuration required</li>
</ul>
<h3 id="negative">Negative</h3>
<ul>
<li><strong>Less flexible</strong>: Cannot delegate recovery to other workloads</li>
<li><strong>Operational constraint</strong>: Requires SPIKE Pilot for disaster recovery
scenarios</li>
<li><strong>Hard-coded policy</strong>: Cannot be changed without code modification</li>
</ul>
<h3 id="neutral">Neutral</h3>
<ul>
<li><strong>Consistent with design</strong>: SPIKE Pilot is already the administrative/operator
interface</li>
<li><strong>Expected behavior</strong>: Recovery is inherently a privileged operation</li>
</ul>
<h2 id="implementation-details">Implementation Details</h2>
<h3 id="sdk-enforcement">SDK Enforcement</h3>
<p>The <code>spike-sdk-go</code> package enforces this in:</p>
<ul>
<li><code>api/internal/impl/operator/recover.go:67-71</code></li>
<li><code>api/internal/impl/operator/restore.go:76-80</code></li>
</ul>
<pre data-lang="go" style="background-color:#2b303b;color:#c0c5ce;" class="language-go "><code class="language-go" data-lang="go"><span style="color:#bf616a;">selfSPIFFEID </span><span>:= </span><span style="color:#bf616a;">svid</span><span>.</span><span style="color:#bf616a;">ID</span><span>.</span><span style="color:#bf616a;">String</span><span>()
</span><span>
</span><span style="color:#65737e;">// Security: Recovery and Restoration can ONLY be done via SPIKE Pilot.
</span><span style="color:#b48ead;">if </span><span>!</span><span style="color:#bf616a;">spiffeid</span><span>.</span><span style="color:#bf616a;">IsPilot</span><span>(</span><span style="color:#bf616a;">selfSPIFFEID</span><span>) {
</span><span>    </span><span style="color:#bf616a;">failErr </span><span>:= </span><span style="color:#bf616a;">sdkErrors</span><span>.</span><span style="color:#bf616a;">ErrUnauthorized
</span><span>    </span><span style="color:#bf616a;">failErr</span><span>.</span><span style="color:#bf616a;">Msg </span><span>= &quot;</span><span style="color:#a3be8c;">recovery can only be performed from SPIKE Pilot</span><span>&quot;
</span><span>    </span><span style="color:#bf616a;">log</span><span>.</span><span style="color:#bf616a;">FatalErr</span><span>(</span><span style="color:#bf616a;">fName</span><span>, *</span><span style="color:#bf616a;">failErr</span><span>)
</span><span>}
</span></code></pre>
<h3 id="operations-not-restricted">Operations NOT Restricted</h3>
<p>The following operations remain policy-controlled and can be performed by any
workload with appropriate policy permissions:</p>
<ul>
<li>Secret operations: <code>Get</code>, <code>Put</code>, <code>Delete</code>, <code>Undelete</code>, <code>List</code>,
<code>GetMetadata</code></li>
<li>Policy operations: <code>Create</code>, <code>Get</code>, <code>Delete</code>, <code>List</code></li>
<li>Cipher operations: <code>Encrypt</code>, <code>Decrypt</code></li>
<li>ACL operations: <code>Get</code>, <code>List</code></li>
<li>Bootstrap operations: <code>Contribute</code>, <code>Verify</code></li>
</ul>
<h3 id="nexus-side-validation">Nexus-Side Validation</h3>
<p>SPIKE Nexus performs additional validation of recovery requests, providing a
second layer of defense even if the SDK check is bypassed.</p>
<h2 id="migration-impact">Migration Impact</h2>
<p>This ADR documents existing behavior and does not require migration. The
restriction has been in place since the recovery operations were first
implemented.</p>
<h2 id="references">References</h2>
<ul>
<li>SPIFFE specification: https://spiffe.io/docs/latest/spiffe-about/overview/</li>
<li>Shamir Secret Sharing: https://en.wikipedia.org/wiki/Shamir%27s_Secret_Sharing</li>
<li>Defense in Depth: https://www.nist.gov/publications/defense-depth-strategy</li>
</ul>
<h2 id="related-adrs">Related ADRs</h2>
<ul>
<li>ADR-0001: Use SPIFFE/SPIRE for Workload Identity</li>
<li>ADR-0028: Use Human-Readable Error Messages in CLI Tools</li>
</ul>
<hr />
<ul>
<li><a href="https://spike.ist/architecture/adrs/adr-0032/">ADR-0032: Standard 12-Byte Nonce Size for AES-GCM</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0031/">ADR-0031: AST-Based Test Enforcement for Route Guard Functions</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0030/">ADR-0030: Minimal Error Messages in API Responses</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0029/">ADR-0029: Restrict Recovery and Restoration Operations to SPIKE Pilot</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0028/">ADR-0028: Use Human-Readable Error Messages in CLI Tools</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0027/">ADR-0027: Separate Audit Logs from Operational Logs</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0026/">ADR-0026: Configurable Data Directory for SPIKE Components</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0025/">ADR-0025: Path Patterns as Key Namespaces with Regular Expression Matching</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0024/">ADR-0024: Transition from In-Memory Cache to Direct Backend Storage for High Availability</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0023/">ADR-0023: Decision Against Implementing Lock/Unlock Mechanism in SPIKE Nexus</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0022/">ADR-0022: Continuous Polling of SPIKE Keepers Despite 404 Response</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0021/">ADR-0021: SPIKE Keeper as a Stateless Shard Holder</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0020/">ADR-0020: Switch to Zola for Documentation System</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0019/">ADR-0019: Plugin-Based Storage Backend Architecture</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0018/">ADR-0018: Administrative Access to SPIKE</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0017/">ADR-0017: Synchronous Persistence for SPIKE Secrets Store</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0016/">ADR-0016: Memory-First Secrets Store</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0015/">ADR-0015: Use Singular Form for File and Package Naming</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0014/">ADR-0014: Maintaining SQLite as SPIKE’s Primary Storage Backend</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0013/">ADR-0013: S3-Compatible Storage as SPIKE’s Backing Store</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0012/">ADR-0012: HTTP Methods for SPIKE API</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0011/">ADR-0011: PostgreSQL as SPIKE’s Backing Store</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0010/">ADR-0010: Session Token Storage Strategy for SPIKE Nexus</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0009/">ADR-0009: Multi-Administrator Support System</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0008/">ADR-0008: Administrative Access Control System</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0007/">ADR-0007: Root Key Lifecycle and Management Strategy</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0006/">ADR-0006: Trust Boundary Definition and Security Assumptions</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0005/">ADR-0005: Use SPIFFE mTLS for Inter-Component Authentication and Communication</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0004/">ADR-0004: SPIKE Keeper Minimalist Design Approach</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0003/">ADR-0003: Root Key Management and Storage Strategy</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0002/">ADR-0002: Use Docsify for Documentation System</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0001/">ADR-0001: Display Secrets in Plain Text in SPIKE Pilot Admin CLI</a></li>
</ul>
<hr />
<ul>
<li><a href="https://spike.ist/architecture/system-overview/"><strong>SPIKE</strong> System Overview</a></li>
<li><a href="https://spike.ist/architecture/security-model/"><strong>SPIKE</strong> Security Model</a></li>
<li><a href="https://spike.ist/architecture/architectural-decision-records/"><strong>SPIKE</strong> Architectural Decision Records</a></li>
</ul>

    
        </article>

        <footer id="footer">
            Copyright © 2024-present <strong>SPIKE Contributors</strong>.<br>
            <strong>SPIKE</strong>'s code
            is distributed under <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache (v2.0)</a>.
            <br>
            The documentation on this website
            is distributed under <a href="https://creativecommons.org/licenses/by/4.0/">CC-BY-4.0</a>.
            <br><br>
            We <strong>do not</strong> collect your data.
            This site <strong>does not</strong> use any tracking cookies or scripts.
        </footer>
    </div>

</main>


    <script type="text/javascript" src="https://spike.ist/elasticlunr.min.js" defer></script>
    <script type="text/javascript" src="https://spike.ist/search_index.en.js" defer></script>
<script type="text/javascript" src="https://spike.ist/js.js" defer></script>
</body>
</html>
<style>
body {
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0;
    font-family: var(--font-family);
    background-color: var(--bg-primary);
    color: var(--text-primary);
}

main {
    width: 100vw;
    max-width: 1920px;
    display: flex;
    flex-direction: row;
    overflow: hidden;
}

#footer {
    text-align: center;
    padding: 2rem;
    font-size: 0.875rem;
    color: var(--text-muted);
    border-top: 1px solid var(--border-color);
    margin-top: 2rem;
}

.content {
    display: flex;
    flex-direction: column;
    flex: 1;
    height: 100vh;
    overflow-y: auto;
    background-color: var(--bg-primary);
    line-height: 1.6;
    border-left: 1px solid var(--border-color);
}

#footer a {
    color: var(--spike-blue);
    text-decoration: none;
    transition: all 0.2s ease;
    border-bottom: 1px solid transparent;
    font-weight: 500;

}

#footer a:hover {
    border-bottom-color: var(--spike-blue);
}

</style>