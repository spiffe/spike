#    \\ SPIKE: Secure your secrets with SPIFFE. â€” https://spike.ist/
#  \\\\\ Copyright 2024-present SPIKE contributors.
# \\\\\\\ SPDX-License-Identifier: Apache-2.0

apiVersion: batch/v1
kind: Job
metadata:
  labels:
    app.kubernetes.io/instance: spiffe
    app.kubernetes.io/name: spike-bootstrap
  name: spiffe-spike-bootstrap
  namespace: spike
spec:
  template:
    metadata:
      labels:
        app.kubernetes.io/instance: spiffe
        app.kubernetes.io/name: spike-bootstrap
        component: spike-bootstrap
    spec:
      restartPolicy: OnFailure
      # DESIGN:
      # The bootstrap binary handles all state management internally:
      # 1. On startup: Checks if ConfigMap exists with bootstrap-completed=true
      # 2. On successful completion: Update ConfigMap to mark completion
      # 3. ConfigMap serves as the persistent completion marker
      # 4. The administrator can delete the ConfigMap to force re-bootstrap
      #    (or use SPIKE_BOOTSTRAP_FORCE=true)
      containers:
      - name: spiffe-spike-bootstrap
        image: localhost:5000/spike-bootstrap:dev
        command: ["/bootstrap", "-init"]
        env:
        - name: SPIKE_NEXUS_API_URL
          value: https://spiffe-spike-nexus:443
        - name: SPIFFE_ENDPOINT_SOCKET
          value: unix:///spiffe-workload-api/spire-agent.sock
        - name: SPIKE_SYSTEM_LOG_LEVEL
          value: DEBUG
        - name: SPIKE_TRUST_ROOT
          value: spike.ist
        - name: SPIKE_NEXUS_SHAMIR_SHARES
          value: "3"
        - name: SPIKE_NEXUS_SHAMIR_THRESHOLD
          value: "2"
        - name: SPIKE_NEXUS_KEEPER_PEERS
          value: "https://spiffe-spike-keeper-0.spiffe-spike-keeper-headless:8443,https://spiffe-spike-keeper-1.spiffe-spike-keeper-headless:8443,https://spiffe-spike-keeper-2.spiffe-spike-keeper-headless:8443"
        - name: SPIKE_BOOTSTRAP_FORCE
          value: "false"
        imagePullPolicy: IfNotPresent
        resources: {}
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          seccompProfile:
            type: RuntimeDefault
        volumeMounts:
        - mountPath: /spiffe-workload-api
          name: spiffe-workload-api
          readOnly: true
      dnsPolicy: ClusterFirst
      securityContext:
        fsGroup: 1000
        fsGroupChangePolicy: OnRootMismatch
        runAsGroup: 1000
        runAsUser: 1000
      serviceAccountName: spiffe-spike-bootstrap
      volumes:
      - csi:
          driver: csi.spiffe.io
          readOnly: true
        name: spiffe-workload-api
---
apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    app.kubernetes.io/instance: spiffe
    app.kubernetes.io/name: spike-bootstrap
  name: spiffe-spike-bootstrap
  namespace: spike
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: spike
  name: spiffe-bootstrap-role
rules:
# Allow Bootstrap to read/write ConfigMaps
- apiGroups: [""]
  resources: ["configmaps"]
  verbs: ["create"]
- apiGroups: [""]
  resources: ["configmaps"]
  verbs: ["get", "update", "patch"]
  # Restrict write to the relevant ConfigMap only.
  resourceNames: ["spike-bootstrap-state"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: spiffe-bootstrap-rolebinding
  namespace: spike
subjects:
- kind: ServiceAccount
  name: spiffe-spike-bootstrap
  namespace: spike
roleRef:
  kind: Role
  name: spiffe-bootstrap-role
  apiGroup: rbac.authorization.k8s.io
